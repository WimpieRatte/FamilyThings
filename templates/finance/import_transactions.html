{% extends "site/site_base.html" %}
{% block append_to_head %}
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/htmx.org@2.0.7/dist/htmx.min.js"></script>
    <style>
        body {
            overflow-y: auto; /* allow standard page scrolling */
        }
    </style>
{% endblock %}
{% block title %}Finance: Import Transactions{% endblock %}
{% block content %}
<div id="accomplishments-overview" class="container-sm pb-4 w-100">
    {% include 'site/heading_section.html' with label="Import Transactions" id="import_transactions" %}
    <div id="import_transactions_container" class="container rounded bg-dark p-2 h-25 mh-25">
        <div class="row g-2 align-items-end">
            <div class="col">
                <label for="import-profile-selector" class="form-label">
                    Select Import Profile
                </label>
                <select class="form-select"
                        aria-label="Select Import Profile"
                        id="import-profile-selector"
                        name="import_profile_selector"
                        tooltip="If this is a file format you haven't imported before, please first create a new import profile accordingly."
                        onchange="change(this.value)">
                    {% if not profiles %}
                        <option selected disabled>Create New</option>
                    {% endif %}
                    {% for profile in profiles %}
                        <option value="{{ profile.id }}">{{ profile.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                {% if profiles %}
                    <a class="btn btn-primary" id="btnEditProfiles" href="{% url 'finance:import_profiles' %}?selected_import_profile={{profiles.0.id}}">Edit Profiles</a>
                {% else %}
                    <a class="btn btn-primary" id="btnEditProfiles" href="{% url 'finance:import_profiles' %}">Edit Profiles</a>
                {% endif %}
            </div>
        </div>
        <br>
        <div class="row g-2 align-items-end">
            <div class="col">
                <label for="formFile" class="form-label">Select file to upload</label>
                <input class="form-control" id="formFile" type="file">
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary"
                        id="btnLoadHeaders"
                        hx-get="{% url 'finance:load_headers' %}"
                        hx-trigger="click"
                        hx-target="#imported_transactions_container"
                >
                    Load Headers
                </button>
            </div>
        </div>
    </div>

    <br>

    <div id="imported_transactions_container">
        {% comment %} Will be loaded via btnLoadHeaders {% endcomment %}
        {% comment %} {% include 'finance/partials/imported_transactions.html' %} {% endcomment %}

    </div>
    <br>
</div>

<script>

    // Change the edit profiles button link based on selected profile
    function change(val){
        document.getElementById("btnEditProfiles").href = "{% url 'finance:import_profiles' %}?selected_import_profile=" + val;
    }

    document.body.addEventListener("htmx:beforeRequest", function (event) {
        if (event.target.id !== "btnLoadHeaders") return;

        const profileSelect = document.getElementById("import-profile-selector");
        const fileInput = document.getElementById("formFile");

        let blocked = false;

        if (!profileSelect.value || profileSelect.value === "Create New") {
            event.preventDefault();
            profileSelect.classList.add("is-invalid");
            alert("Please pick an import profile before loading headers.");
            blocked = true;
        } else {
            profileSelect.classList.remove("is-invalid");
        }

        if (!fileInput.files.length) {
            event.preventDefault();
            fileInput.classList.add("is-invalid");
            if (!blocked) {
                alert("Please select a file before loading headers.");
            }
        } else {
            fileInput.classList.remove("is-invalid");
        }
    });

</script>

{% endblock %}