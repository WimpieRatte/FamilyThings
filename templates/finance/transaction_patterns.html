{% extends "site/site_base.html" %}
{% block append_to_head %}
    {% load static %}
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
{% endblock %}

{% block title %}Finance: Transaction Patterns{% endblock %}

{% block content %}
<div class="container-sm pb-4 w-100">
    {% include 'site/heading_section.html' with label="Transaction Patterns" id="transaction_patterns" %}

    <div class="container rounded bg-dark p-4 mb-4">
        <!-- Messages Container -->
        <div id="pattern-messages"></div>

        <!-- Add Pattern Form -->
        <div class="row mb-4">
            <div class="col">
                <h5 class="text-light mb-3">Add New Pattern</h5>
                <form id="pattern-form" class="row g-3"
                    hx-post="{% url 'finance:create_transaction_pattern' %}"
                    hx-trigger="load, change"
                    hx-target="#divnr2"
                    hx-include="[name='name_regex'], [name='category_id']"
                >
                    {% csrf_token %}
                    <div class="col-md-4">
                        <label for="name_regex" class="form-label text-light">Name Pattern *</label>
                        <input type="text" class="form-control" id="name_regex" name="name_regex" required>
                        <div class="form-text text-light">Text to match in transaction names</div>
                    </div>

                    <div class="col-md-3">
                        <label for="category_id" class="form-label text-light">Category *</label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            <option value="">Select Category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="align-middle">
                        <button type="submit" class="btn btn-primary" id="btn-add-pattern">
                            Add
                        </button>
                    </div>
                </form>
                <script>
                // Direct event listener as fallback
                document.getElementById('pattern-form')?.addEventListener('submit', function(event) {
                    console.log('Direct event listener triggered!');
                    handleAddPattern(event);
                });
                </script>
            </div>
        </div>

        <!-- Patterns Table -->
        <div class="row">
            <div class="col">
                <h5 class="text-light mb-3">Existing Patterns</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover bg-opacity-50" id="patterns-table">
                        <thead>
                            <tr>
                                <th>Name Pattern</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patterns-tbody">
                            {% if patterns %}
                                {% for pattern in patterns %}
                                <tr data-pattern-id="{{ pattern.id }}">
                                    <td>{{ pattern.name_regex }}</td>
                                    <td>{{ pattern.transaction_category_id.name }}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-outline-warning edit-pattern"
                                                data-pattern-id="{{ pattern.id }}">
                                            Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-pattern"
                                                data-pattern-id="{{ pattern.id }}"
                                                data-pattern-name="{{ pattern.name_regex }}">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        No transaction patterns found. Add your first pattern above.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Pattern Modal -->
<div class="modal fade" id="editPatternModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Edit Transaction Pattern</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-pattern-form">
                    {% csrf_token %}
                    <input type="hidden" id="edit-pattern-id" name="pattern_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="edit-name_regex" class="form-label">Name Pattern *</label>
                            <input type="text" class="form-control" id="edit-name_regex" name="name_regex" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-category_id" class="form-label">Category *</label>
                            <select class="form-select" id="edit-category_id" name="category_id" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-update-pattern">Update Pattern</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script>
// Transaction Patterns Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializePatternsManagement();
});

function initializePatternsManagement() {
    // Add Pattern Form Submission
    const patternForm = document.getElementById('pattern-form');
    if (patternForm) {
        patternForm.addEventListener('submit', handleAddPattern);
    }

    // Edit Pattern Buttons
    document.querySelectorAll('.edit-pattern').forEach(button => {
        button.addEventListener('click', handleEditPattern);
    });

    // Delete Pattern Buttons
    document.querySelectorAll('.delete-pattern').forEach(button => {
        button.addEventListener('click', handleDeletePattern);
    });

    // Update Pattern Button in Modal
    const updateButton = document.getElementById('btn-update-pattern');
    if (updateButton) {
        updateButton.addEventListener('click', handleUpdatePattern);
    }
}

function handleAddPattern(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const submitButton = document.getElementById('btn-add-pattern');
    const originalText = submitButton.textContent;

    // Disable button during request
    submitButton.textContent = 'Adding...';
    submitButton.disabled = true;

    fetch("{% url 'finance:create_transaction_pattern' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addPatternToTable(data.pattern);
            form.reset();
            showPatternMessage(`Pattern "${data.pattern.name_regex}" added successfully!`, 'success');
        } else {
            showPatternMessage('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showPatternMessage('Error adding pattern: ' + error.message, 'error');
    })
    .finally(() => {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
}

function handleEditPattern(event) {
    const patternId = event.target.dataset.patternId;
    const row = event.target.closest('tr');

    // Populate modal with current data
    document.getElementById('edit-pattern-id').value = patternId;
    document.getElementById('edit-name_regex').value = row.cells[0].textContent;

    // Find and set the category
    const categoryName = row.cells[1].textContent;
    const categorySelect = document.getElementById('edit-category_id');
    for (let option of categorySelect.options) {
        if (option.text === categoryName) {
            option.selected = true;
            break;
        }
    }

    // Reset advanced fields to hidden state
    const editAdvancedFields = document.getElementById('edit-advanced-fields');
    const editShowAdvancedButton = document.getElementById('edit-show-advanced');
    if (editAdvancedFields && editShowAdvancedButton) {
        editAdvancedFields.style.display = 'none';
        editShowAdvancedButton.textContent = 'Show Advanced Fields';
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editPatternModal'));
    modal.show();
}

function handleUpdatePattern() {
    const form = document.getElementById('edit-pattern-form');
    const formData = new FormData(form);
    const patternId = document.getElementById('edit-pattern-id').value;
    const updateButton = document.getElementById('btn-update-pattern');
    const originalText = updateButton.textContent;

    // Disable button during request
    updateButton.textContent = 'Updating...';
    updateButton.disabled = true;

    fetch(`/finance/transaction-patterns/update/${patternId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePatternInTable(data.pattern);
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPatternModal'));
            modal.hide();
            showPatternMessage(`Pattern "${data.pattern.name_regex}" updated successfully!`, 'success');
        } else {
            showPatternMessage('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showPatternMessage('Error updating pattern: ' + error.message, 'error');
    })
    .finally(() => {
        updateButton.textContent = originalText;
        updateButton.disabled = false;
    });
}

function handleDeletePattern(event) {
    const patternId = event.target.dataset.patternId;
    const patternName = event.target.dataset.patternName;

    if (!confirm(`Are you sure you want to delete the pattern "${patternName}"?`)) {
        return;
    }

    const deleteButton = event.target;
    const originalText = deleteButton.textContent;

    // Disable button during request
    deleteButton.textContent = 'Deleting...';
    deleteButton.disabled = true;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/finance/transaction-patterns/delete/${patternId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `csrfmiddlewaretoken=${csrfToken}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            removePatternFromTable(patternId);
            showPatternMessage(data.message, 'success');
        } else {
            showPatternMessage('Error: ' + data.error, 'error');
            deleteButton.textContent = originalText;
            deleteButton.disabled = false;
        }
    })
    .catch(error => {
        showPatternMessage('Error deleting pattern: ' + error.message, 'error');
        deleteButton.textContent = originalText;
        deleteButton.disabled = false;
    });
}

function addPatternToTable(pattern) {
    const tbody = document.getElementById('patterns-tbody');

    // Remove empty state if it exists
    const emptyState = tbody.querySelector('td[colspan]');
    if (emptyState) {
        emptyState.closest('tr').remove();
    }

    const row = document.createElement('tr');
    row.dataset.patternId = pattern.id;
    row.innerHTML = `
        <td>${pattern.name_regex}</td>
        <td>${pattern.category_name}</td>
        <td class="action-buttons">
            <button class="btn btn-sm btn-outline-warning edit-pattern"
                    data-pattern-id="${pattern.id}">
                Edit
            </button>
            <button class="btn btn-sm btn-outline-danger delete-pattern"
                    data-pattern-id="${pattern.id}"
                    data-pattern-name="${pattern.name_regex}">
                Delete
            </button>
        </td>
    `;

    tbody.appendChild(row);

    // Add event listeners to new buttons
    row.querySelector('.edit-pattern').addEventListener('click', handleEditPattern);
    row.querySelector('.delete-pattern').addEventListener('click', handleDeletePattern);
}

function updatePatternInTable(pattern) {
    const row = document.querySelector(`tr[data-pattern-id="${pattern.id}"]`);
    if (row) {
        row.cells[0].textContent = pattern.name_regex;
        row.cells[1].textContent = pattern.category_name;

        // Update the delete button data attribute
        const deleteButton = row.querySelector('.delete-pattern');
        deleteButton.dataset.patternName = pattern.name_regex;
    }
}

function removePatternFromTable(patternId) {
    const row = document.querySelector(`tr[data-pattern-id="${patternId}"]`);
    if (row) {
        row.remove();
    }

    // Show empty state if no patterns left
    const tbody = document.getElementById('patterns-tbody');
    if (tbody.children.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    No transaction patterns found. Add your first pattern above.
                </td>
            </tr>
        `;
    }
}

function showPatternMessage(message, type) {
    const messageContainer = document.getElementById('pattern-messages');
    if (messageContainer) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        messageContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const alert = messageContainer.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
}

// Toggle advanced fields
const showAdvancedButton = document.getElementById('btn-show-advanced');
const advancedFields = document.getElementById('advanced-fields');

if (showAdvancedButton && advancedFields) {
    showAdvancedButton.addEventListener('click', function() {
        if (advancedFields.style.display === 'none') {
            advancedFields.style.display = 'block';
            this.textContent = 'Hide Advanced';
        } else {
            advancedFields.style.display = 'none';
            this.textContent = 'Show Advanced';
        }
    });
}

// Toggle advanced fields in edit modal
const editShowAdvancedButton = document.getElementById('edit-show-advanced');
const editAdvancedFields = document.getElementById('edit-advanced-fields');

if (editShowAdvancedButton && editAdvancedFields) {
    editShowAdvancedButton.addEventListener('click', function() {
        if (editAdvancedFields.style.display === 'none') {
            editAdvancedFields.style.display = 'block';
            this.textContent = 'Hide Advanced Fields';
        } else {
            editAdvancedFields.style.display = 'none';
            this.textContent = 'Show Advanced Fields';
        }
    });
}


</script>