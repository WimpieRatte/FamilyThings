<div id="imported_transactions_container" class="container rounded bg-dark p-2 h-25 mh-25">
    <div class="row g-2 align-items-end">
        <div class="row">
            <div class="col">
                <label for="txtNewCategoryName" class="form-label">
                    Category Management
                </label>
            </div>
        </div>
        <form id="frmCategories">
            {% csrf_token %}
            <div class="row align-items-center">
                <div class="col">
                    <div class="form-floating">
                        <input type="text" id="txtCategoryName" class="form-control" placeholder="New Category Name"/>
                        <label for="txtCategoryName" class="form-label">New Category Name</label>
                    </div>
                </div>
                <div class="col-auto d-flex align-items-center">
                    <button type="submit" class="btn btn-primary" id="btnAddCategory"
                        hx-post="{% url 'finance:create_category' %}"
                        hx-trigger="click"
                        hx-target=".category_select_boxes"
                        hx-headers="js:{'X-Current-Path': 'import_transactions', 'txtCategoryNameValue': document.getElementById('txtCategoryName').value}"
                    >
                        Add Category
                    </button>
                </div>
                <div class="col-auto d-flex align-items-center">
                    <a class="btn btn-primary" id="btnEditCategories" href="{% url 'finance:edit_categories' %}">Edit Categories</a>
                </div>
            </div>
        </form>
    </div>

    <br>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if success %}
        <div class="alert alert-success">
            Processed {{ row_count }} rows. Row categories auto-detected: {{ detected_categories }}
        </div>

        <div class="row g-2 align-items-end">
            <div class="row">
                <div class="col">
                    <label class="form-label">
                        Imported Transactions
                    </label>
                </div>
            </div>

            <div class="table-responsive">
                {% if html_output %}
                    {{ html_output|safe }}
                {% endif %}
            </div>
        </div>
        {% comment %} TODO: Add a button that saves all transactions: {% endcomment %}
        {% comment %} <br>
        <div class="d-flex justify-content-center">
            <button class="btn btn-primary" id="btnImportTransactions" onclick="saveAll()">Import All</button>
        </div> {% endcomment %}
    {% endif %}
</div>

<br>

<div id="imported_transactions_container" class="container rounded bg-dark p-2 h-25 mh-25">
    <div class="row g-2 align-items-end">
        <div class="row">
            <div class="col" id="category-summary-chart">
                <!-- The pie chart gets loaded here -->
                <div class="chart-container">
                    <div id="piechart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>


////////////////////////////////////////// Scripts for saving transactions: ///////////////////////////

    // Function to read headers and build the data structure
    function getTableStructure() {
        const table = document.getElementById('transactions-table');
        const headers = [];
        const headerCells = table.querySelectorAll('thead tr th');

        headerCells.forEach((th, index) => {
            headers.push({
                index: index,
                name: th.textContent.trim(),
                field: th.dataset.field || th.textContent.trim().toLowerCase().replace(/\s+/g, '_'),
                editable: th.dataset.editable !== 'false',
                lookup: th.dataset.lookup || null
            });
        });

        return headers;
    }

    // Function to extract data from table
    function extractTableData() {
        const headers = getTableStructure();
        const table = document.getElementById('transactions-table');
        const rows = table.querySelectorAll('tbody tr');
        const data = [];

        rows.forEach(row => {
            const rowData = { id: row.dataset.id || null };
            const cells = row.querySelectorAll('td');

            headers.forEach(header => {
                if (cells[header.index]) {
                    let value;

                    if (header.editable && cells[header.index].querySelector('select, input')) {
                        // Handle form elements
                        const input = cells[header.index].querySelector('select, input');
                        value = input.value;
                    } else if (cells[header.index].hasAttribute('contenteditable')) {
                        // Handle contenteditable cells
                        value = cells[header.index].textContent;
                    } else {
                        // Handle regular cells
                        value = cells[header.index].textContent;
                    }

                    rowData[header.field] = value;

                    // Store original value for lookups if needed
                    if (header.lookup) {
                        rowData[`${header.field}_display`] = cells[header.index].textContent;
                    }
                }
            });

            data.push(rowData);
        });

        return { headers, data };
    }

    // Save data to server
    function saveTableData() {
        const tableData = extractTableData();

        fetch('/save-dynamic-table/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                table_structure: tableData.headers,
                table_data: tableData.data,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Data saved successfully!');
            }
        });
    }
</script>